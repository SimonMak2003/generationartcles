<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Федералист | Генератор кода (без PARSEHTML)</title>
    <style>
        body { font-family: "Segoe UI", sans-serif; background: #eceff1; padding: 20px; color: #333; }
        .wrapper { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: #ddd; border-radius: 5px; }
        .tab-btn.active { background: #006aa7; color: white; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea { min-height: 80px; }
        .btn-add { background: #4caf50; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; margin-top: 10px; }
        #output { width: 100%; min-height: 200px; margin-top: 20px; background: #f9f9f9; font-family: monospace; font-size: 12px; padding: 10px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; align-items: flex-start; }
        .delete-btn { background: #ff5252; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; height: 36px; }
        .dialog-item { border-left: 4px solid #006aa7; padding: 10px; margin-bottom: 10px; background: #f1f8ff; border-radius: 4px; }
        .diag-name { padding: 8px; box-sizing: border-box; }
        .diag-text { padding: 8px; box-sizing: border-box; min-height: 60px; resize: vertical; }
        /* Небольшие стили для предпросмотра результата */
        #preview { margin-top: 20px; border: 1px solid #ddd; padding: 15px; background: #fff; border-radius: 6px; }
        .ArticleHeader { text-align: justify; font-family: Yeseva One, serif; }
        .ArticleText { text-align: justify; font-family: Cambria, serif; }
        .ArticleNote { border-top: 2px solid #7f7679; padding-top: 12px; border-bottom: 2px solid #7f7679; padding-bottom: 12px; border-left: 2px solid #7f7679; padding-left: 12px; border-right: 2px solid #7f7679; padding-right: 12px; text-align: center; font-family: Yeseva One, serif; }
        .ArticleCitation { background-color: #f5f5f5; border-radius: 20px; padding: 5px 30px; text-align: justify; font-family: Yeseva One, serif; font-size: large; }
        .AuthorColumn { border-radius: 1em; padding-top: 0.5em; padding-bottom: 0.5em; font-family: 'Yeseva One', serif; background-color: #f5f5f5; --color: #006aa7; }
        .AuthorInfo { padding-left: 1em; padding-right: 1em; display: grid; grid-template-columns: 2fr 1fr; align-items: center; }
        .AuthorProfile { display: flex; gap: 0.5em; align-items: center; }
        .AuthorPfp { height: 3em; width: 3em; border-radius: 50%; border: 0.2em solid var(--color); }
        .AuthorName { font-size: 1.5em; margin: 0; }
        .AuthorDesc { border-left: 0.2em solid var(--color); padding-left: 0.5em; font-size: 0.8em; margin: 0; }
        .yp_interview_question, .yp_interview_answer { background-color: #f5f5f5; border-radius: 10px; font-family: -apple-system, 'Noto Serif'; padding: 15px; margin: 10px 0; color: #000; text-align: justify; }
        .yp_interview_question { margin-right: 30%; }
        .yp_interview_answer { margin-left: 30%; }
        .yp_interviewer, .yp_interviewee { font-weight: bold; display: block; margin-bottom: 6px; }
        @media screen and (max-width: 980px) {
          .yp_interview_question, .yp_interview_answer { margin-right: 0; margin-left: 0; }
          .AuthorInfo { grid-template-columns: 1fr; }
          .AuthorDesc { border-top: 0.2em solid var(--color); border-left: 0; padding-left: 0; }
        }
    </style>
</head>
<body>

<div class="wrapper">
    <h2>Генератор контента «Федералист» (без PARSEHTML)</h2>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="switchMode(event,'article')">Статья</button>
        <button class="tab-btn" onclick="switchMode(event,'interview')">Интервью</button>
    </div>

    <!-- Поля для статьи -->
    <div id="article-fields">
        <div class="input-group"><label>Инфо (Дата | Категория)</label><input type="text" id="art_info" placeholder="6 июня | Политика"></div>
        <div class="input-group"><label>Название</label><input type="text" id="art_title" placeholder="Заголовок статьи"></div>
        <div class="input-group"><label>Логлайн</label><input type="text" id="art_logline" placeholder="Краткая суть"></div>
        <div class="input-group"><label>Первый абзац</label><textarea id="art_first"></textarea></div>
        <div class="input-group"><label>Ссылка на картинку статьи</label><input type="text" id="art_img" placeholder="https://..."></div>
        <div class="input-group"><label>Основной текст</label><textarea id="art_main" style="height: 200px"></textarea></div>
        <div class="input-group"><label>Автор (BB-код)</label><input type="text" id="art_author" placeholder="[USER=8]Имя[/USER]"></div>
        <div class="input-group"><label>Ссылка на фото автора</label><input type="text" id="art_author_img" placeholder="https://..."></div>
    </div>

    <!-- Поля для интервью -->
    <div id="interview-fields" style="display:none;">
        <div class="input-group"><label>Заголовок интервью</label><input type="text" id="int_title" placeholder="Дальновидность, гибкость, эмпатия"></div>
        <div id="dialog-container"></div>
        <button class="btn-add" onclick="addDialog('question')">+ Вопрос (Слева)</button>
        <button class="btn-add" onclick="addDialog('answer')">+ Ответ (Справа)</button>
    </div>

    <hr>
    <button class="btn-add" style="background:#006aa7; width: 100%; font-size: 18px;" onclick="generate()">Сгенерировать код</button>

    <label style="margin-top:20px; display:block;">Результат (HTML — скопируйте в сообщение или в файл):</label>
    <textarea id="output" readonly></textarea>

    <label style="margin-top:10px; display:block;">Предпросмотр (рэндорится как HTML):</label>
    <div id="preview"></div>
</div>

<script>
let currentMode = 'article';

function switchMode(ev, mode) {
    currentMode = mode;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (ev && ev.currentTarget) ev.currentTarget.classList.add('active');
    document.getElementById('article-fields').style.display = mode === 'article' ? 'block' : 'none';
    document.getElementById('interview-fields').style.display = mode === 'interview' ? 'block' : 'none';
}

function addDialog(type) {
    const container = document.getElementById('dialog-container');
    const div = document.createElement('div');
    div.className = 'dialog-item';
    div.dataset.type = type;
    div.innerHTML = `
        <div class="row">
            <input type="text" placeholder="Кто говорит (Имя)" class="diag-name" style="width:30%">
            <textarea placeholder="Текст реплики" class="diag-text" style="width:60%"></textarea>
            <div style="width:10%; display:flex; align-items:flex-start; justify-content:flex-end;">
                <button class="delete-btn" title="Удалить" onclick="removeDialog(this)">X</button>
            </div>
        </div>
    `;
    container.appendChild(div);
}

function removeDialog(btn) {
    let el = btn;
    while (el && !el.classList.contains('dialog-item')) {
        el = el.parentElement;
    }
    if (el && el.parentElement) el.parentElement.removeChild(el);
}

function safeTrim(str) {
    return (str || '').toString().trim();
}

// Простая функция для HTML-эскейпинга строк (чтобы в тексте не ломать генерацию)
function escapeHtml(str) {
    return (str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function nl2brEscaped(str) {
    // сначала эскейпим, затем заменим новые строки на <br>
    return escapeHtml(str).replace(/\r?\n/g, '<br>');
}

function generate() {
    const noteHtml = `<div class="ArticleNote">Вы можете поддержать издание «Федералист», поставив реакцию к статье, присоединившись к её обсуждению или отправив донат игровой валюты (или золота) автору статьи.</div>`;

    let finalHtml = "";

    if (currentMode === 'article') {
        const info = escapeHtml(safeTrim(document.getElementById('art_info').value));
        const title = escapeHtml(safeTrim(document.getElementById('art_title').value));
        const logline = escapeHtml(safeTrim(document.getElementById('art_logline').value));
        const first = nl2brEscaped(safeTrim(document.getElementById('art_first').value));
        const img = safeTrim(document.getElementById('art_img').value) || 'https://via.placeholder.com/900x200';
        const main = nl2brEscaped(safeTrim(document.getElementById('art_main').value));
        const author = escapeHtml(safeTrim(document.getElementById('art_author').value) || '[USER=0]Автор[/USER]');
        const authorImg = safeTrim(document.getElementById('art_author_img').value) || 'https://via.placeholder.com/100';

        finalHtml =
`<div class="ArticleHeader">
  ${info}
  <h1>${title}</h1>
  <h2>${logline}</h2>
</div>

<div style="text-align: center; padding: 20px 0 0;">
  <img src="${img}" style="width: 100%; object-fit: cover; max-height: 200px; box-shadow: 0 3px 6px rgba(0,0,0,0.16);">
</div>

<br>

<div class="ArticleText">
  <p>${first}</p>
  <p>${main}</p>
</div>

<div class="AuthorColumn">
  <div class="AuthorInfo">
    <div class="AuthorProfile">
      <img class="AuthorPfp" src="${authorImg}" alt="author">
      <p class="AuthorName">${author}</p>
    </div>
    <p class="AuthorDesc">Автор статьи</p>
  </div>
</div>

${noteHtml}`;
    } else {
        const intTitle = escapeHtml(safeTrim(document.getElementById('int_title').value)) || 'Интервью';
        const items = Array.from(document.querySelectorAll('.dialog-item'));

        let dialogsHtml = '';
        items.forEach(item => {
            const type = item.dataset.type === 'answer' ? 'answer' : 'question';
            const rawName = safeTrim(item.querySelector('.diag-name').value) || (type === 'question' ? 'The Federalist' : '[USER=3333]Интервьюируемый[/USER]');
            const rawText = safeTrim(item.querySelector('.diag-text').value);
            const name = escapeHtml(rawName);
            const text = nl2brEscaped(rawText);
            if (type === 'question') {
                dialogsHtml += `
<div class="yp_interview_question">
  <p class="yp_interviewer">${name}</p>
  <p class="yp_interview_qtext">${text}</p>
</div>`;
            } else {
                dialogsHtml += `
<div class="yp_interview_answer">
  <p class="yp_interviewee">${name}</p>
  <p class="yp_interview_atext">${text}</p>
</div>`;
            }
        });

        finalHtml =
`<div class="ArticleHeader">
  <h1>${intTitle}</h1>
</div>

${dialogsHtml}

${noteHtml}`;
    }

    finalHtml = finalHtml.trim();
    if (!finalHtml) {
        alert('Нечего генерировать. Заполните поля.');
        return;
    }

    document.getElementById('output').value = finalHtml;
    // Предпросмотр: вставляем как HTML
    document.getElementById('preview').innerHTML = finalHtml;
}
</script>

</body>
</html>
